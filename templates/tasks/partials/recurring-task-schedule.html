{% load task_tags %}

<div class="flex mt-1"
     x-data="{
        loading: false,
        deleted: false
     }"
     hx-target="this"
>
    <div class="d-flex">
        <div class="col-md-7 col-12 form-group">
            <label for="{{ recurring_task.pk }}-start-date" class="form-label">Start Date</label>
            <input name="start-time"
                   type="datetime-local"
                   id="{{ recurring_task.pk }}-start-date"
                   class="form-control"
                   hx-post="{% url 'update-recurring-task-schedule' recurring_task.pk %}"
                   hx-trigger="change"
                   hx-vals="js:{'update-schedule-only': true}"
                   @change="() => {
                       // short interval to let htmx send out the post request before disabling the input form
                       // otherwise, the input form will not have the correct value
                       setTimeout(() => loading = true, 200);
                   }"
                   x-bind:value="() => {
                       const localizedDate = new Date({{recurring_task.start_time|date:'U'}} * 1000);
                       localizedDate.setMinutes(localizedDate.getMinutes() - new Date().getTimezoneOffset());
                       let isoString = localizedDate.toISOString();
                       return isoString.substring(0, (isoString.indexOf('T')|0) + 6|0);
                   }"
                   x-bind:disabled="loading"
            />
        </div>
        <div class="w-100 form-group">
            <label for="{{ recurring_task.pk }}-interval" class="form-label">Interval</label>
            <select class="form-select"
                    name="interval"
                    @change="loading = true"
                    hx-post="{% url 'update-recurring-task-schedule' recurring_task.pk %}"
                    hx-trigger="change"
                    hx-vals="js:{'update-schedule-only': true}"
                    x-bind:disabled="loading"
                    id="{{ recurring_task.pk }}-interval">
                {% interval_choices as interval_choices %}
                {% for choice in interval_choices %}
                <option value="{{ choice.0 }}"
                        {% if recurring_task.interval in choice.0 %} selected="selected" {% endif %}
                >
                    {{ choice.1 }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <small x-show="loading == false"
           class="text-muted">This task will be created again within {{ recurring_task.days_till_next_task }}
        day{% if recurring_task.days_till_next_task > 1 %}s {% endif %}.</small>
    <small x-cloak x-show="loading && !deleted" class="text-muted">
        <span class="spinner-border spinner-border-sm"
              role="status"
              aria-hidden="true"></span>
        Loading...</small>
</div>
